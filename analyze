#!/usr/bin/env bash
set -euo pipefail

# ── SWE-Bench+ PR Quality Analyzer ─────────────────────────────────────────
# Analyzes merged pull requests for SWE-Bench+ dataset suitability.
# Runs a Docker build check first; only PRs that build proceed to AI analysis.
#
# Usage:
#   ./analyze                    Analyze all merged PRs
#   ./analyze --pr 3             Analyze a single PR
#   ./analyze --parallel 2       Run 2 reviews at once
#   ./analyze --dry-run          List PRs without reviewing
#   ./analyze --force-ai-check   Run AI analysis even if Docker build fails
#   ./analyze --help             Show all options
# ────────────────────────────────────────────────────────────────────────────

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PYTHON_SCRIPT="$SCRIPT_DIR/analyze_prs.py"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BOLD='\033[1m'
NC='\033[0m'

fail() { echo -e "${RED}Error:${NC} $1" >&2; exit 1; }
warn() { echo -e "${YELLOW}Warning:${NC} $1" >&2; }
ok()   { echo -e "  ${GREEN}✓${NC} $1"; }

# ── Prerequisite checks ────────────────────────────────────────────────────

echo -e "${BOLD}SWE-Bench+ PR Quality Analyzer${NC}"
echo "Checking prerequisites..."
echo

errors=0

# Python 3.11+
if command -v python3 &>/dev/null; then
    py_version=$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
    py_major=$(echo "$py_version" | cut -d. -f1)
    py_minor=$(echo "$py_version" | cut -d. -f2)
    if [ "$py_major" -ge 3 ] && [ "$py_minor" -ge 11 ]; then
        ok "Python $py_version"
    else
        fail "Python 3.11+ required (found $py_version).
    Install: https://www.python.org/downloads/"
    fi
else
    echo -e "  ${RED}✗${NC} Python 3 not found"
    echo "    Install: https://www.python.org/downloads/"
    errors=$((errors + 1))
fi

# GitHub CLI
if command -v gh &>/dev/null; then
    if gh auth status &>/dev/null 2>&1; then
        ok "GitHub CLI (authenticated)"
    else
        echo -e "  ${RED}✗${NC} GitHub CLI not authenticated"
        echo "    Run: gh auth login"
        errors=$((errors + 1))
    fi
else
    echo -e "  ${RED}✗${NC} GitHub CLI not found"
    echo "    Install: https://cli.github.com"
    errors=$((errors + 1))
fi

# Docker (SKIPPED - not needed for AI analysis)
if command -v docker &>/dev/null; then
    if docker info &>/dev/null 2>&1; then
        ok "Docker (running)"
    else
        echo -e "  ${RED}✗${NC} Docker daemon not running"
        echo "    Start Docker Desktop or the Docker daemon"
        errors=$((errors + 1))
    fi
else
    echo -e "  ${RED}✗${NC} Docker not found"
    echo "    Install: https://docs.docker.com/get-docker/"
    errors=$((errors + 1))
fi
# ok "Docker check SKIPPED"

# OpenAI API key for kimi-2.5 via ai.pratikn.com
if [ -n "${OPENAI_API_KEY:-}" ]; then
    ok "OPENAI_API_KEY set"
else
    ok "OPENAI_API_KEY not set"
fi

# OpenAI API key 2 (alternative)
if [ -n "${OPENAI_API_KEY2:-}" ]; then
    ok "OPENAI_API_KEY2 set"
else
    ok "OPENAI_API_KEY2 not set (will use OPENAI_API_KEY or built-in default)"
fi

# API endpoint check
if [ -n "${OPENAI_BASE_URL:-}" ]; then
    ok "OPENAI_BASE_URL set (${OPENAI_BASE_URL})"
else
    ok "OPENAI_BASE_URL not set"
fi

# API endpoint 2 check (alternative)
if [ -n "${OPENAI_BASE_URL2:-}" ]; then
    ok "OPENAI_BASE_URL2 set (${OPENAI_BASE_URL2})"
else
    ok "OPENAI_BASE_URL2 not set (will use OPENAI_BASE_URL or built-in default)"
fi

# Git repo
if git rev-parse --is-inside-work-tree &>/dev/null 2>&1; then
    ok "Inside git repository"
else
    echo -e "  ${RED}✗${NC} Not inside a git repository"
    echo "    Run this from inside the cloned repo"
    errors=$((errors + 1))
fi

# Script exists
if [ -f "$PYTHON_SCRIPT" ]; then
    ok "analyze_prs.py found"
else
    fail "analyze_prs.py not found at $PYTHON_SCRIPT"
fi

echo

if [ "$errors" -gt 0 ]; then
    fail "Fix the $errors issue(s) above and try again."
fi

# ── Run ─────────────────────────────────────────────────────────────────────

echo -e "${BOLD}Starting analysis...${NC}"
echo
exec python3 "$PYTHON_SCRIPT" "$@"
